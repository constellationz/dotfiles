#!/usr/bin/env bash
# Rsync backup with:
# - ssh using key login
# - archive permissions
# - verbose
# - stream compression
# - progress
# - partial sync
# - 500 kb/s bandwidth limit
# - write to /home/luna
#
# Note: These operations use wireguard
# - Change hopper.wg to hopper.local
# - Optionally remove bandwidth limit

# Set SYNCDIR: Use $HOME/Desktop/sync or $HOME/sync
if [[ -d "$HOME/Desktop/sync" ]]; then
  SYNCDIR="$HOME/Desktop/sync"
elif [[ -d "$HOME/sync" ]]; then
  SYNCDIR="$HOME/sync"
else
  echo "Sync directory not found, either ~/Desktop/sync or ~/sync must exist"
  exit 1
fi

# Set REMOTE
# Exit if not defined
REMOTE="$1"
if [ -z "$REMOTE" ]; then
  echo "Usage: $(basename $0) hopper.wg0"
  exit 2
fi

# The folder name which sync will be copied to on the remote
DESTDIR="/home/$(hostname -s)"
# Where to save rsync logs
LOGDIR="$HOME/rsynclog"
# Logfile to write to
LOGFILE="$LOGDIR/sync-$REMOTE-log.txt"
# ssh command to use for rsync
RSYNC_RSH="ssh -p 1183 -i ~/.ssh/hopper"
# The exact rsync destination (directory) to sync to
TO="$(whoami)@$REMOTE:$DESTDIR"

# Make log directory for tee command
mkdir -p "$LOGDIR"

# One-directional sync (with deletion)
# Make sure to do dry-run before initiating actual transfer
echo "syncing $SYNCDIR/ -> $TO/"
rsync \
  --archive \
  --compress \
  --delete-after \
  --partial \
  --progress \
  --verbose \
  --exclude '.hist' \
  "$SYNCDIR/" "$TO/" | tee -a $LOGFILE
echo "bak: rsync $SYNCDIR/ -> $TO/ complete"
